<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <title>Forum - Thread</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/home.css" />
  </head>
  <body>
    <header class="header">
      <a href="#" class="logo">Lucas</a>
    </header>
    <div class="stylebar"></div>
    <nav class="navbar">
      <ul>
        <li><a href="../html/home.html">Home</a></li>
        <li><a href="#">About</a></li>
        <li><a href="#">Contact</a></li>
        <li><a href="#">Login</a></li>
      </ul>
    </nav>

    <h1 id="thread-title"></h1>
    <p><strong>Catégorie:</strong> <span id="thread-category"></span></p>
    <p><strong>Description:</strong> <span id="thread-description"></span></p>
    <p><strong>Date:</strong><span id="thread-date"></span></p>

    <h2>Commentaires</h2>
    <div id="comments-container"></div>

    <div id="comment-form-container">
      <textarea
        id="comment-content"
        placeholder="Votre commentaire..."
      ></textarea>
      <button id="submit-comment">Envoyer</button>
    </div>

    <script type="module">
      import { getThreadById } from "../js/threadController.js";

      async function getCurrentUserId() {
        return 1; // temporaire pour test
      }

      async function loadThread() {
        const threadId = new URLSearchParams(window.location.search).get("id");
        const thread = await getThreadById(threadId);

        document.getElementById("thread-title").textContent = thread.Title;
        document.getElementById("thread-category").textContent =
          thread.Category;
        document.getElementById("thread-description").textContent =
          thread.Description;
        document.getElementById("thread-date").textContent = new Date(
          Number(thread.Date)
        ).toDateString();

        await loadComments(threadId);
      }

      async function loadComments(threadId) {
        const res = await fetch(`/api/comments/${threadId}`);
        const comments = await res.json();
        const container = document.getElementById("comments-container");
        container.innerHTML = "";
        const tree = renderComments(comments);
        container.appendChild(tree);

        document.querySelectorAll(".reply-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            document.getElementById(`reply-form-${id}`).style.display = "block";
          });
        });
      }

      function renderComments(comments, parentId = null) {
        const container = document.createElement("div");
        comments
          .filter((c) => c.parent_id === parentId)
          .forEach((comment) => {
            const div = document.createElement("div");
            div.style.marginLeft = parentId ? "20px" : "0";
            div.innerHTML = `
          <p><strong>${comment.username}</strong>: ${comment.content}</p>
          <button class="reply-btn" data-id="${comment.id}">Répondre</button>
          <div class="reply-form" id="reply-form-${comment.id}" style="display:none;">
            <textarea id="reply-text-${comment.id}" placeholder="Votre réponse..."></textarea>
            <button onclick="submitReply(${comment.id})">Envoyer</button>
          </div>
        `;
            div.appendChild(renderComments(comments, comment.id));
            container.appendChild(div);
          });
        return container;
      }

      window.submitReply = async function (parentId) {
        const threadId = new URLSearchParams(window.location.search).get("id");
        const content = document.getElementById(`reply-text-${parentId}`).value;
        const userId = await getCurrentUserId();

        await fetch("/api/comments", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            thread_id: threadId,
            user_id: userId,
            content,
            parent_id: parentId,
          }),
        });

        await loadComments(threadId);
      };

      document
        .getElementById("submit-comment")
        .addEventListener("click", async () => {
          const threadId = new URLSearchParams(window.location.search).get(
            "id"
          );
          const content = document.getElementById("comment-content").value;
          const userId = await getCurrentUserId();

          await fetch("/api/comments", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              thread_id: threadId,
              user_id: userId,
              content,
            }),
          });

          document.getElementById("comment-content").value = "";
          await loadComments(threadId);
        });

      window.addEventListener("DOMContentLoaded", loadThread);
    </script>
  </body>
</html>
